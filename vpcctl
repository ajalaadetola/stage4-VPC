# Create a debug version of vpcctl
cat > vpcctl-debug << 'EOF'
#!/bin/bash

set -e  # Exit on error

VPC_DIR="/tmp/vpc_configs"

echo "=== VPC DEBUG START ==="
echo "Command: $0 $*"
echo "VPC_DIR: $VPC_DIR"

# Ensure directory exists
mkdir -p "$VPC_DIR"
echo "Directory created: $(ls -la $VPC_DIR)"

case "$1" in
    create-vpc)
        vpc_name="$2"
        cidr_block="$3"
        echo "Creating VPC: $vpc_name with CIDR: $cidr_block"
        
        config_file="$VPC_DIR/$vpc_name.conf"
        echo "Config file: $config_file"
        
        # Create bridge
        bridge_name="br-$vpc_name"
        echo "Creating bridge: $bridge_name"
        ip link add "$bridge_name" type bridge
        ip link set "$bridge_name" up
        
        # Calculate gateway
        gateway_ip="${cidr_block%.*}.1"
        echo "Gateway IP: $gateway_ip"
        
        # Save configuration
        echo "Saving configuration to: $config_file"
        cat > "$config_file" << CONFIG
CIDR=$cidr_block
BRIDGE=$bridge_name
GATEWAY=$gateway_ip
SUBNETS=
CONFIG
        
        echo "Config file content:"
        cat "$config_file"
        echo "✅ VPC $vpc_name created"
        ;;
        
    list-vpcs)
        echo "Listing VPCs from: $VPC_DIR"
        if [ -d "$VPC_DIR" ]; then
            for config_file in "$VPC_DIR"/*.conf; do
                if [ -f "$config_file" ]; then
                    echo "Found: $(basename $config_file .conf)"
                    cat "$config_file"
                fi
            done
        else
            echo "No VPC directory found"
        fi
        ;;
        
    create-subnet)
        vpc_name="$2"
        subnet_name="$3"
        subnet_cidr="$4"
        echo "Creating subnet: $subnet_name in VPC: $vpc_name"
        
        config_file="$VPC_DIR/$vpc_name.conf"
        if [ ! -f "$config_file" ]; then
            echo "❌ VPC $vpc_name not found"
            exit 1
        fi
        
        echo "Loading VPC config from: $config_file"
        source "$config_file"
        echo "Bridge: $BRIDGE, Gateway: $GATEWAY"
        
        # Create namespace
        ns_name="ns-$vpc_name-$subnet_name"
        echo "Creating namespace: $ns_name"
        ip netns delete "$ns_name" 2>/dev/null || true
        ip netns add "$ns_name"
        
        # Create veth pair
        veth_host="veth-$vpc_name-$subnet_name-host"
        veth_ns="veth-$vpc_name-$subnet_name-ns"
        
        echo "Creating veth pair: $veth_host <-> $veth_ns"
        ip link delete "$veth_host" 2>/dev/null || true
        ip link add "$veth_host" type veth peer name "$veth_ns"
        
        # Configure networking
        echo "Configuring networking..."
        ip link set "$veth_ns" netns "$ns_name"
        ip link set "$veth_host" master "$BRIDGE"
        ip link set "$veth_host" up
        
        ip netns exec "$ns_name" ip link set lo up
        ip netns exec "$ns_name" ip link set "$veth_ns" up
        ip netns exec "$ns_name" ip addr add "$subnet_cidr" dev "$veth_ns"
        ip netns exec "$ns_name" ip route add default via "$GATEWAY"
        
        echo "✅ Subnet $subnet_name created"
        ;;
        
    *)
        echo "Usage: $0 {create-vpc|create-subnet|list-vpcs}"
        ;;
esac

echo "=== VPC DEBUG END ==="
EOF

chmod +x vpcctl-debug
